<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
<meta charset="UTF-8" />
<title>{{ t["app_title"] }} â€“ {{ t["studio"] }}</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="google-site-verification" content="3wv8okeMixKUeLRVUHDQU26HUsneKxIx62qF_qiXAfs" />

<style>
:root{
  --bg: linear-gradient(135deg, #ffe9d2, #fff7e6);
  --accent:#ff9b4a;
  --accent-soft:rgba(255,155,74,.14);
  --text:#222;
  --muted:#666;
  --card:#ffffff;
  --radius:22px;
  --shadow:0 18px 50px rgba(0,0,0,.10);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:var(--bg);
  color:var(--text);
}
.page{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
}
.app{
  width:100%;
  max-width:1080px;
  background:rgba(255,255,255,.78);
  border-radius:32px;
  box-shadow:var(--shadow);
  padding:24px;
}

/* HEADER */
.header{
  margin-bottom:18px;
}
.header-hero{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:18px;
  margin-bottom:18px;
}

/* SINISTRA */
.brand-text{
  display:flex;
  flex-direction:column;
  gap:6px;
  text-align:left;
}
.brand-title{
  font-weight:900;
  letter-spacing:.02em;
  font-size:1.30rem;
  line-height:1.1;
}
.brand-studio{
  font-weight:900;
  letter-spacing:.14em;
  text-transform:uppercase;
  font-size:1.0rem;
  color:#222;
  opacity:0.85;
}
.brand-tagline{
  font-size:.95rem;
  color:var(--muted);
  line-height:1.2;
}

/* DESTRA */
.right-tools{
  justify-self:end;
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:nowrap;
}
.lang{
  display:flex;
  align-items:center;
  gap:8px;
}
.lang select{
  padding:7px 12px;
  border-radius:999px;
  border:1px solid #ddd;
  background:#fff;
  font-size:.88rem;
}
.badge{
  padding:7px 12px;
  border-radius:999px;
  font-size:.78rem;
  background:rgba(32,201,151,.12);
  color:#0f7a5c;
  font-weight:800;
  display:flex;
  align-items:center;
  gap:8px;
  white-space:nowrap;
}
.badge span{
  width:8px;height:8px;
  background:#20c997;
  border-radius:50%;
}

/* LAYOUT */
.layout{
  display:grid;
  grid-template-columns:1.05fr 1.3fr;
  gap:20px;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:18px;
  border:1px solid #eee;
}
.error{
  background:#ffe0e0;
  color:#a00000;
  padding:9px 11px;
  border-radius:12px;
  margin-bottom:12px;
  font-size:.85rem;
  border:1px solid #ffb3b3;
}
.card h2{
  margin:0 0 10px;
  font-size:1rem;
}
.helper{
  margin:0 0 16px;
  font-size:.85rem;
  color:var(--muted);
}
form{
  display:flex;
  flex-direction:column;
  gap:12px;
}
label{font-size:.85rem;color:#444;}
input,select{
  padding:9px 11px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:.95rem;
  background:#fafafa;
}
input:focus,select:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(255,155,74,.25);
  background:#fff;
}
.row{display:grid;gap:10px;}
.row.two{grid-template-columns:1.4fr .8fr;}
.row.opt{grid-template-columns:1fr 1fr;}
.submit{display:flex;justify-content:flex-end;}
button[type="submit"]{
  padding:8px 14px;
  font-size:0.9rem;
  font-weight:900;
  border-radius:999px;
  border:none;
  cursor:pointer;
  background:linear-gradient(135deg,var(--accent),#ff7a18);
  color:#fff;
  box-shadow:0 6px 14px rgba(255,122,24,.30);
}

/* RECIPE */
.recipe-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:8px;
  flex-wrap:wrap;
}
.recipe-title{
  font-size:.9rem;
  color:var(--muted);
  font-weight:800;
}
.actions{display:flex;gap:8px;flex-wrap:wrap;}
.action-btn{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,155,74,.35);
  background:rgba(255,255,255,.90);
  color:#b45717;
  font-weight:800;
  font-size:.78rem;
  cursor:pointer;
  box-shadow:0 3px 8px rgba(0,0,0,.08);
}
.action-btn:hover{background:rgba(255,231,204,.75);}
.recipe-box{
  background:#fafafa;
  border-radius:14px;
  padding:14px;
  border:1px solid #eee;
  max-height:60vh;
  overflow-y:auto;
  font-size:.9rem;
}
.recipe-pre{
  margin:0 0 10px;
  white-space:pre-wrap;
  font-family:ui-monospace,Consolas,monospace;
  font-size:.86rem;
}
.ing-table{
  width:100%;
  border-collapse:collapse;
  margin:10px 0 12px;
  font-size:.86rem;
  border-radius:12px;
  overflow:hidden;
}
.ing-table th,.ing-table td{
  border:1px solid #e2e2e2;
  padding:8px 10px;
}
.ing-table th{
  background:#f2d9c2;
  font-weight:900;
}
.ing-table td:last-child,.ing-table th:last-child{
  text-align:right;
  white-space:nowrap;
}

/* FOOTER */
.footer{
  margin-top:18px;
  padding-top:12px;
  border-top:1px solid #eee;
  text-align:center;
  font-size:.78rem;
  color:#888;
  line-height:1.5;
}

/* RESPONSIVE */
@media(max-width:820px){
  .layout{grid-template-columns:1fr}
  .header-hero{
    grid-template-columns:1fr;
    justify-items:center;
    text-align:center;
    gap:12px;
  }
  .brand-text{align-items:center}
  .right-tools{
    justify-self:center;
    flex-wrap:wrap;
    justify-content:center;
  }
}
@media(max-width:520px){
  .app{padding:16px}
  .row.two,.row.opt{grid-template-columns:1fr}
  .submit{justify-content:stretch}
  button[type="submit"]{width:100%}
  .recipe-box{max-height:50vh}
}
</style>
</head>

<body>
<div class="page">
  <div class="app">

    <!-- HEADER -->
    <header class="header header-hero">
      <div class="brand-text">
        <div class="brand-title">{{ t["app_title"] }}</div>
        <div class="brand-studio">{{ t["studio"] }}</div>
        <div class="brand-tagline">{{ t["tagline"] }}</div>
      </div>

      <div class="right-tools">
        <div class="lang">
          <span style="font-size:.85rem;color:rgba(0,0,0,.55)">{{ t["language"] }}</span>
          <form method="GET" style="margin:0">
            <select name="lang" onchange="this.form.submit()">
              <option value="it" {% if lang=="it" %}selected{% endif %}>ðŸ‡®ðŸ‡¹ IT</option>
              <option value="en" {% if lang=="en" %}selected{% endif %}>ðŸ‡¬ðŸ‡§ EN</option>
              <option value="es" {% if lang=="es" %}selected{% endif %}>ðŸ‡ªðŸ‡¸ ES</option>
              <option value="fr" {% if lang=="fr" %}selected{% endif %}>ðŸ‡«ðŸ‡· FR</option>
              <option value="de" {% if lang=="de" %}selected{% endif %}>ðŸ‡©ðŸ‡ª DE</option>
            </select>
          </form>
        </div>

        <div class="badge"><span></span>Home Edition</div>
      </div>
    </header>

    <div class="layout">

      <!-- SINISTRA -->
      <section class="card">
        {% if error %}
          <div class="error">{{ error }}</div>
        {% endif %}

        <h2>{{ t["create"] }}</h2>
        <p class="helper">{{ t["helper"] }}</p>

        <form method="POST">
          <input type="hidden" name="lang" value="{{ lang }}">

          <div class="row two">
            <div>
              <label for="flavour">{{ t["flavour"] }}</label>
              <input id="flavour" type="text" name="flavour" value="{{ flavour or '' }}" required>
            </div>
            <div>
              <label for="quantity">{{ t["quantity"] }}</label>
              <input id="quantity" type="text" name="quantity" value="{{ quantity or '' }}" required>
            </div>
          </div>

          <div class="row opt">
            <div>
              <label for="profilo">{{ t["profile"] }}</label>
              <select id="profilo" name="profilo">
                {% for value, label in t["profile_opts"].items() %}
                  <option value="{{ value }}" {% if profilo==value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="metodo">{{ t["method"] }}</label>
              <select id="metodo" name="metodo">
                {% for value, label in t["method_opts"].items() %}
                  <option value="{{ value }}" {% if metodo==value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="submit">
            <button type="submit">{{ t["generate"] }}</button>
          </div>
        </form>
      </section>

      <!-- DESTRA -->
      <section class="card">
        <div class="recipe-header">
          <div class="recipe-title">
            {% if recipe %}{{ t["recipe_generated"] }}{% else %}{{ t["no_recipe"] }}{% endif %}
          </div>

          {% if recipe %}
          <div class="actions">

            {% if pdf_unlocked %}
              <!-- PDF sbloccato: mostra il download -->
              <form method="POST" action="/download_pdf" style="margin:0;">
                <input type="hidden" name="lang" value="{{ lang }}">
                <input type="hidden" name="flavour" value="{{ flavour or '' }}">
                <input type="hidden" name="quantity" value="{{ quantity or '' }}">
                <input type="hidden" name="profilo" value="{{ profilo or '' }}">
                <input type="hidden" name="metodo" value="{{ metodo or '' }}">
                <textarea name="recipe_text" style="display:none;">{{ recipe }}</textarea>
                <button type="submit" class="action-btn">ðŸ“„ {{ t["pdf"] }}</button>
              </form>
            {% else %}
              <form method="POST" action="{{ url_for('stripe_checkout', lang=lang) }}">
                <button type="submit" class="action-btn premium">
                  ðŸ’³ Scarica PDF â€“ 0,99â‚¬
                </button>
              </form>
            {% endif %}

          </div>
          {% endif %}
        </div>

        {% if recipe %}
          <div id="recipeBox" class="recipe-box"></div>
          <script>
            const rawRecipe = {{ recipe | tojson | safe }} || "";
            const tColIng = {{ t["col_ing"] | tojson | safe }};
            const tColQty = {{ t["col_qty"] | tojson | safe }};
            const pdfNote = {{ t["note_pdf"] | tojson | safe }};
          </script>
        {% else %}
          <p class="helper" style="margin:0">{{ t["helper"] }}</p>
        {% endif %}
      </section>

    </div>

    <footer class="footer">
      <strong>{{ t["footer_app_l1"] }}</strong><br>
      {{ t["footer_app_l2"] }}<br>
      {{ t["footer_app_l3"] }}<br>
      <span>
        {{ t.get("footer_contact_label","Contatti") }}:
        <a href="mailto:support@nimuegelateria.com">
          support@nimuegelateria.com
        </a>
      </span>
    </footer>

  </div>
</div>

<script>
function escapeHtml(s){
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function renderRecipe(text){
  const container = document.getElementById("recipeBox");
  if(!container) return;

  const lines = text.split("\n");

  let start=-1, end=-1;
  for(let i=0;i<lines.length;i++){
    const s = lines[i].trim();
    if(s.startsWith("|") && s.split("|").length >= 3){ start=i; break; }
  }

  if(start !== -1){
    let j=start;
    while(j<lines.length){
      const s = lines[j].trim();
      if(s.startsWith("|") && s.split("|").length >= 3){ j++; continue; }
      if(s===""){ j++; continue; }
      break;
    }
    end=j;
  }

  if(start === -1 || end === -1){
    container.innerHTML = `<pre class="recipe-pre">${escapeHtml(text)}</pre>`;
    return;
  }

  const before = lines.slice(0,start).join("\n").trimEnd();
  const tableLines = lines.slice(start,end).filter(l=>{
    const s=l.trim();
    if(!s.startsWith("|")) return false;
    const inner=s.replaceAll("|","").trim();
    if(inner.length>0 && [...inner].every(ch => ch==="-" || ch===" ")) return false;
    return true;
  });

  const rows = [];
  for(const line of tableLines){
    const parts = line.split("|").map(p=>p.trim()).filter(Boolean);
    if(parts.length >= 2) rows.push([parts[0], parts[1]]);
  }
  const dataRows = (rows.length >= 2) ? rows.slice(1) : [];

  let html = "";
  if(before) html += `<pre class="recipe-pre">${escapeHtml(before)}</pre>`;

  if(dataRows.length){
    html += `
      <table class="ing-table">
        <thead><tr><th>${escapeHtml(tColIng || "Ingredient")}</th><th>${escapeHtml(tColQty || "Quantity (g)")}</th></tr></thead>
        <tbody>
          ${dataRows.map(r=>`
            <tr><td>${escapeHtml(r[0])}</td><td>${escapeHtml(r[1])}</td></tr>
          `).join("")}
        </tbody>
      </table>
    `;

    if (typeof pdfNote === "string" && pdfNote.trim()) {
      html += `<p class="helper" style="margin-top:8px; font-weight:700;">${escapeHtml(pdfNote)}</p>`;
    }
  }

  container.innerHTML = html;
}

function copyRecipe(){
  if(typeof rawRecipe !== "string") return;
  navigator.clipboard.writeText(rawRecipe).catch(()=>{});
}

if(typeof rawRecipe === "string" && rawRecipe.trim()){
  renderRecipe(rawRecipe);
}
</script>

{% if request.args.get('dl') == '1' %}
<script>
  const url = "{{ url_for('download_pdf', lang=lang) }}";

  // Metodo 1 (piÃ¹ affidabile): nuova scheda per il download
  const w = window.open(url, "_blank");

  // Fallback: se il popup Ã¨ bloccato, usa iframe
  if (!w) {
    const iframe = document.createElement("iframe");
    iframe.style.display = "none";
    iframe.src = url;
    document.body.appendChild(iframe);
  }

  // Ripulisci l'URL per evitare loop
  setTimeout(() => {
    const cleanUrl = "{{ url_for('app_page', lang=lang, keep=1) }}";
    window.history.replaceState({}, "", cleanUrl);
  }, 800);
</script>
{% endif %}



</body>
</html>
